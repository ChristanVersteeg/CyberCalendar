name: Daily Tip Update

on:
  schedule:
    - cron: '0 0 * * *'
  workflow_dispatch:
  push:
    branches: [ main ]

jobs:
  update-tip:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Get current tip
        id: tip
        env:
          TIPS_JSON: ${{ secrets.TIPS_JSON }}
        run: |
          DAY=$(date +%j | sed 's/^0*//')
          TIP=$(echo "$TIPS_JSON" | jq -r ".tips[$((DAY-1))].text")
          echo "tip=$TIP" >> $GITHUB_OUTPUT

      - name: Get current image (PNG only)
        id: image
        env:
          TIPS_JSON: ${{ secrets.TIPS_JSON }}
          GITHUB_TOKEN: ${{ secrets.PAT }}
        run: |
          set -euo pipefail
          set -x
      
          # 1) Which day-of-year are we on?
          DAY=$(date +%j | sed 's/^0*//')
          echo "ðŸ”¢ DAY: $DAY"
      
          # 2) Pull the bare image name from your JSON
          IMAGE_BASE=$(jq -r ".tips[$((DAY-1))].image" <<< "$TIPS_JSON")
          echo "ðŸ–¼ Raw name: '$IMAGE_BASE'"
      
          # 3) If it's empty or "null", skip
          if [[ -z "$IMAGE_BASE" || "$IMAGE_BASE" == "null" ]]; then
            echo "âš ï¸  No image for today"
            echo "image=" >> $GITHUB_OUTPUT
            exit 0
          fi
      
          # 4) Only try .png
          IMG="${IMAGE_BASE}.png"
          URL="https://api.github.com/repos/ChristanVersteeg/CyberTips/contents/images/${IMG}"
          echo "ðŸŒ Downloading $IMG from $URL"
      
          STATUS=$(curl -sSL \
            -H "Authorization: Bearer $GITHUB_TOKEN" \
            -H "Accept: application/vnd.github.v3.raw" \
            -w "%{http_code}" \
            -o "$IMG" \
            "$URL" || true)
      
          echo "ðŸ“¬ HTTP status: $STATUS"
      
          if [[ "$STATUS" == "200" && -s "$IMG" ]]; then
            echo "âœ… Fetched $IMG ($(stat -c '%s' "$IMG") bytes)"
            IMAGE="$IMG"
          else
            echo "âŒ Could not fetch $IMG; skipping"
            rm -f "$IMG"
            IMAGE=""
          fi
      
          # 5) Export whatever we got (or empty)
          echo "image=$IMAGE" >> $GITHUB_OUTPUT
        
        
        
        
        
      - name: Prepare gh-pages branch
        run: |
          git config --global user.name "GitHub Actions"
          git config --global user.email "actions@github.com"
          git checkout --orphan temp
          git rm -rf .

      - name: Create index.html
        env:
          IMAGE: ${{ steps.image.outputs.image }}
        run: |
          # start the document
          cat <<EOF > index.html
          <!DOCTYPE html>
          <html>
          <head>
            <meta charset="UTF-8">
            <title>Daily Tip</title>
          </head>
          <body>
            <h1>Today's Tip:</h1>
            <div id="tip"></div>
          EOF
      
          # if we have an image filename, insert an <img> element
          if [ -n "$IMAGE" ]; then
            cat <<EOF >> index.html
            <div id="tip-image">
              <img src="$IMAGE" alt="Daily tip illustration" />
            </div>
          EOF
          fi
      
          # finish up with the script and closing tags
          cat <<EOF >> index.html
            <script>
              fetch('tip.txt')
                .then(response => response.text())
                .then(tip => document.getElementById('tip').textContent = tip);
            </script>
          </body>
          </html>
          EOF
        

      - name: Add daily tip
        run: |
          echo "${{ steps.tip.outputs.tip }}" > tip.txt
          git add tip.txt index.html
          git commit -m "Daily tip update: $(date +%F)"

      - name: Force push to gh-pages
        run: |
          git branch -D gh-pages || true
          git branch -m gh-pages
          git push -f origin gh-pages