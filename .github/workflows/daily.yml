name: Daily Secret Publish

on:
  schedule:
    - cron: "0 0 * * *"  # Runs at 00:00 UTC every day
  workflow_dispatch:      # Allows manual trigger in GitHub Actions

jobs:
  publish-secret:
    runs-on: ubuntu-latest
    steps:

      # 1) Check out the repo so we can modify files
      - name: Check out repo
        uses: actions/checkout@v3

      # 2) Retrieve TEXT_ARRAY from Secrets with a multiline block
      - name: Retrieve text array
        id: get_text_array
        run: |
          # We store the secret's content in a multiline output named "array"
          echo "array<<EOF" >> $GITHUB_OUTPUT
          echo "${{ secrets.TEXT_ARRAY }}" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      # 3) Parse the JSON array, pick today's snippet, update snippet.html
      - name: Pick daily snippet
        run: |
          # Read or initialize currentIndex
          if [ -f current_index.txt ]; then
            currentIndex=$(cat current_index.txt)
          else
            currentIndex=0
          fi

          # Parse the array in Python, picking the currentIndex
          dailySnippet=$(python -c "import json; data=json.loads('${{ steps.get_text_array.outputs.array }}'); print(data[$currentIndex])")

          # Write snippet.html
          cat <<EOF > snippet.html
          <h2>Today's snippet</h2>
          <p>${dailySnippet}</p>
          EOF

          # Determine the next index (optionally wrap around with modulo)
          arrayLength=$(python -c "import json; data=json.loads('${{ steps.get_text_array.outputs.array }}'); print(len(data))")
          nextIndex=$(( (currentIndex + 1) % arrayLength ))
          
          echo $nextIndex > current_index.txt

      # 4) Commit and push the updated snippet and index
      - name: Commit and push
        run: |
          git config user.name "github-actions"
          git config user.email "github-actions@github.com"
          git add snippet.html current_index.txt
          git commit -m "Update daily snippet: index $currentIndex"
          git push
